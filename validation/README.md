# Validation

This directory contains **oracle testing** and **cross-validation** infrastructure for MLIR optimization passes.

## Purpose

**Validation** tests compare our semantics against external tools and real-world MLIR behavior. This is distinct from **testing** (in `test/`), which validates our implementation of parsers, semantics, and interpreters.

## Directory Structure

```
validation/
├── oracle/         # Oracle testing (differential testing)
│   ├── sccp/       # SCCP pass oracle tests
│   └── dce/        # DCE pass oracle tests
│
├── cross-check/    # Cross-validation with MLIR toolchain
│   └── README.md
│
└── benchmarks/     # Performance benchmarks
```

## Oracle Testing

**Purpose**: Compare execution outputs of programs before/after optimization.

**Method**:
1. Run original MLIR through our interpreter
2. Run optimized MLIR (via `mlir-opt`) through our interpreter
3. Compare outputs

**Location**: `validation/oracle/`

### Example

```bash
# Original program
validation/oracle/sccp/sccp_addi.mlir

# Optimized version (generated by mlir-opt)
validation/oracle/sccp/sccp_addi.opt.mlir
```

**Test execution**:
```bash
dune test                                    # Run all tests
dune exec test/test_driver.exe -- test "Oracle Testing"  # Run only oracle tests
```

## Cross-Validation

**Purpose**: Compare our interpreter's behavior against MLIR's C++ interpreter or llc.

**Status**: Planned (not yet implemented)

**Location**: `validation/cross-check/`

## Benchmarks

**Purpose**: Performance measurements and stress testing.

**Status**: Planned (not yet implemented)

**Location**: `validation/benchmarks/`

## Important Distinctions

### Validation vs Testing

| Aspect | Testing (`test/`) | Validation (`validation/`) |
|--------|-------------------|----------------------------|
| **What** | Our tools (parser, semantics, interpreter) | External MLIR behavior |
| **Purpose** | Verify correctness of implementation | Detect semantic differences |
| **Against** | Golden outputs we define | External tools (mlir-opt, MLIR interpreter) |
| **Examples** | "Does parser handle syntax correctly?" | "Does SCCP produce equivalent programs?" |

### Oracle Testing vs Translation Validation

| Aspect | Oracle Testing (here) | Translation Validation (future) |
|--------|-----------------------|----------------------------------|
| **Method** | Execute and compare outputs | Prove semantic equivalence in Coq |
| **Guarantee** | Bug detection | Formal correctness |
| **Coverage** | Specific test inputs | All possible inputs |
| **Location** | `validation/oracle/` | `src/Pass/`, `src/Theory/` |

See [ADR-0002: Hybrid Validation Strategy](../docs/adr/ADR-0002-hybrid-validation-strategy.md) for details.

## Adding New Oracle Tests

### 1. Create test files

```bash
# Create directory for new pass
mkdir -p validation/oracle/new-pass/

# Add original program
cat > validation/oracle/new-pass/example.mlir << 'EOF'
func.func @example() -> i32 {
  // ...
}
EOF

# Generate optimized version
mlir-opt validation/oracle/new-pass/example.mlir \
  -pass-pipeline='builtin.module(func.func(new-pass))' \
  -o validation/oracle/new-pass/example.opt.mlir
```

### 2. Add test to `test/dune`

```dune
(deps
  ...
  (file ../validation/oracle/new-pass/example.mlir)
  (file ../validation/oracle/new-pass/example.opt.mlir))
```

### 3. Add test case to `test/test_driver.ml`

```ocaml
make_translation_validation_test
  ~name:"New pass example"
  ~mlir_file:"oracle/new-pass/example.mlir"
  ~opt_mlir_file:(Some "oracle/new-pass/example.opt.mlir")
  ~pass_pipeline:"builtin.module(func.func(new-pass))"
```

### 4. Run tests

```bash
dune test -f
```

## Current Coverage

- ✅ SCCP (Sparse Conditional Constant Propagation)
  - Constant folding (addi)
  - Constant conditional branches
- ❌ DCE (Dead Code Elimination) - planned
- ❌ Inlining - planned
- ❌ Canonicalization - planned

## References

- [Oracle Testing Guide](../docs/howto/translation-validation-testing.md)
- [ADR-0002: Hybrid Validation Strategy](../docs/adr/ADR-0002-hybrid-validation-strategy.md)
- [Directory Structure Design](../docs/design/directory-structure.md)
